<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/me319/libs/katex/katex.min.css"> <link rel=stylesheet  href="/me319/libs/highlight/github.min.css"> <link rel=stylesheet  href="/me319/css/franklin.css"> <link rel=stylesheet  href="/me319/css/poole_hyde.css"> <link rel=stylesheet  href="/me319/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 968px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/me319/assets/c.svg"> <title>Prelab 7</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <br> <img src="/me319/assets/KuwaitUniversityLogoTextLight.svg" style="width: 200px; height: auto; display: inline"> <h1 style="font-size:2em; opacity: 0.75;"><a href="/me319/">ME 319</a></h1> <p class=lead >Mechatronics</p> </div> <script> function hidePart(part_div) { var x = document.getElementById(part_div); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/me319/">Home</a> <a class="sidebar-nav-item " href="/me319/videos/">Lecture Videos</a> <a class="sidebar-nav-item " href="https://alsaibie.github.io/embedded_ccpp">Embedded C/C++ Mini-Course</a> <a class="sidebar-nav-item " href="/me319/lab_assignments/">Lab Assignments</a> <br> <small style="text-transform: uppercase; font-size: 0.75em">Lab Lessons</small> <div class=part  onclick="hidePart('prelabs_div')">Prelabs</div> <div id=prelabs_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabs/prelab2/"><b>Lab 2</b> - <em>PlatformIO and Arduino</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab3/"><b>Lab 3</b> - <em>Debugging and LL Programming</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab4/"><b>Lab 4</b> - <em>Timers and Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab5/"><b>Lab 5</b> - <em>Serial Communication</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab6/"><b>Lab 6</b> - <em>Offline Digital Filtering</em></a> <a class="sidebar-nav-item active" href="/me319/prelabs/prelab7/"><b>Lab 7</b> - <em>Online Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab8/"><b>Lab 8</b> - <em>Motor Dynamics and Control</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab9/"><b>Lab 9</b> - <em>Realtime Motor Control</em></a> </div> <div class=part  onclick="hidePart('addlessons_div')">Additional Lessons</div> <div id=addlessons_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabsextra/lab4extra/"> <b>L4E</b> - <em>Low Level Timers Configuration</em></a> <a class="sidebar-nav-item " href="/me319/prelabsextra/kalmanfilter/"> <b>L6E</b> - <em>Kalman Filter</em></a> </div> <br> <small style="text-transform: uppercase; font-size: 0.75em">Class Lectures</small> <div class=part  onclick="hidePart('part1_div')">I The Brain</div> <div id=part1_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_i/lecture0/"><b>L0</b> - <em>Introduction</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture1/"><b>L1</b> - <em>Microcontroller Architecture</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture2/"><b>L2</b> - <em>Digital Arithmetic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture3/"><b>L3</b> - <em>Digital Logic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture4/"><b>L4</b> - <em>Microcontroller Peripherals</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture5/"><b>L5</b> - <em>GPIO</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture6/"><b>L6</b> - <em>Timers</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture7/"><b>L7</b> - <em>Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture8/"><b>L8</b> - <em>Communication</em></a> </div> <div class=part  onclick="hidePart('part2_div')">II The Cells</div> <div id=part2_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_ii/lecture1/"><b>L1</b> - <em>Passive Circuits</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture2/"><b>L2</b> - <em>Switching Semiconductors</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture3/"><b>L3</b> - <em>Operational Amplifiers</em></a> </div> <div class=part  onclick="hidePart('part3_div')">III The Senses</div> <div id=part3_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iii/lecture1/"><b>L1</b> - <em>Signal Conditioning and Filtering</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture2/"><b>L2</b> - <em>Sensor Charactersitics</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture3/"><b>L3</b> - <em>Survey of Sensors</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture4/"><b>L4</b> - <em>Motion Sensors</em></a> </div> <div class=part  onclick="hidePart('part4_div')">IV The Muscles</div> <div id=part4_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iv/lecture1/"><b>L1</b> - <em>DC Motors</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture2/"><b>L2</b> - <em>Practical Feedback Control</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture4/"><b>L3</b> - <em>Stepper Motors</em></a> </div> <div class=part  onclick="hidePart('part5_div')">V The Body</div> <div id=part5_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_v/lecture1/"><b>L1</b> - <em>System Integration</em></a> </div> </nav> <p>&copy; Ali AlSaibie, PhD.</p> </div> </div> <div class="content container"> <div class=franklin-content ><h1 id=prelab_7_online_digital_filtering ><a href="#prelab_7_online_digital_filtering" class=header-anchor >Prelab 7: Online Digital Filtering</a></h1> <p>In the previous lab, we introduced digital filter design and analysis offline. In this lab we will apply a digital filter on real sensor values. In this prelab, we will explore the data from the sensor expansion board and learn how to log the sensor data for offline processing.</p> <iframe src="https://player.vimeo.com/video/559617825" width=640  height=360  frameborder=0  allowfullscreen></iframe> <h2 id=tools_required ><a href="#tools_required" class=header-anchor >Tools Required </a></h2> <ul> <li><p>MATLAB v 2016b or higher, with DSP or Signal Processing Toolbox andControl System Toolbox</p> <li><p>STM32 Nucleo F401R</p> <li><p>IKS01A02 Expansion Board</p> <li><p><a href="/me319/prelabs/pl7assets/ME319S21Prelab7.zip">Prelab 7 Project Files</a></p> </ul> <p> <center><img src="/me319/prelabs/pl7assets/image1.png" style="max-width:520px"></center> </p> <h2 id=project_setup ><a href="#project_setup" class=header-anchor >Project Setup</a></h2> <p>Download the <a href="/me319/prelabs/pl7assets/ME319S21Prelab7.zip">Prelab 7 Project</a>, it contains both the PlatformIO project and the MATLAB script files &#40;under <code>script</code> folder&#41;</p> <p>Add the IKS01A02 expansion board onto your Nucleo board. The expansion board &#40;or shield&#41; connects via the Arduino headers. It only uses a few pins for power and I2C connection, the rest of the pins are passed through the headers on the expansion board itself. </p> <h2 id=demos ><a href="#demos" class=header-anchor >Demos</a></h2> <p>We will look at the data coming from the Accelerometer, Gyroscope, Magnetometer, Pressure Sensor and Humidity &amp; Temperature Sensor respectively. Then discuss how the data can be logged from the PC side for offline analysis. </p> <p>The communication with all of the sensors in this lab is done via the I2C serial communication protocol. The Arduino framework includes methods for I2C communication through the <code>Wire.h</code> protocol. </p> <pre><code class="cpp hljs"><span class=hljs-meta >#<span class=hljs-keyword >define</span> DEV_I2C Wire</span></code></pre>
<h2 id=i_accelerometer_lsm6dsl ><a href="#i_accelerometer_lsm6dsl" class=header-anchor >I.  <strong>Accelerometer LSM6DSL</strong></a></h2>
<p>There are two accelerometers on the expansion board, one on the LSM6DSL sensor and another on LSM303AGR sensor. We are using the accelerometer on the LSM6DSL sensor.</p>
<p>Compile and run <code>mainE1ACC.cpp</code>, then connect the serial terminal and observe the data from the accelerometer. Rotate the board in the x, y and z direction and observe the change in values. When the board is placed upright on a table the z axis should read close to <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mi>m</mi><mi>g</mi></mrow><annotation encoding="application/x-tex">1000mg</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span><span class=mord >0</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span> &#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mn>9.81</mn><mi>m</mi><mtext>/</mtext><msup><mi>s</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">g = 9.81m\text{/}s^{2}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord >9</span><span class=mord >.</span><span class=mord >8</span><span class=mord >1</span><span class="mord mathnormal">m</span><span class="mord text"><span class=mord >/</span></span><span class=mord ><span class="mord mathnormal">s</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>&#41;, if the board is flipped face down, the z-axis accelerometer axis should read close to <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1000</mn><mi>m</mi><mi>g</mi></mrow><annotation encoding="application/x-tex">-1000mg</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class=mord >−</span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span><span class=mord >0</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>.</p>
<p>There is a library provided for each of the sensors on the expansion board. The sensor libraries are wrapped in C&#43;&#43; classes. They each require that the I2C device pointer is passed to them on construction. </p>
<pre><code class="cpp hljs">LSM6DSLSensor *AccGyr; <span class=hljs-comment >// A pointer to the Accelerometer class object</span></code></pre>
<p>The sensor libraries take care of configuring and communicating with the sensors. Externally, you only need to call a few number of methods</p>
<p>When creating the sensor object, you need to pass it the I2C device pointer. </p>
<pre><code class="cpp hljs">AccGyr    = <span class=hljs-keyword >new</span> <span class=hljs-built_in >LSM6DSLSensor</span>(&amp;DEV_I2C); <span class=hljs-comment >// Creating a new instance and passing a pointer to the I2C device</span></code></pre>
<p>Some routines may need to be done, including configuring the sensor and that&#39;s wrapped in the enable function of the sensor object. </p>
<pre><code class="cpp hljs">AccGyr-&gt;<span class=hljs-built_in >Enable_X</span>(); <span class=hljs-comment >// Enable Accelerometer</span></code></pre>
<p>To get a new sample from the sensor, you can pass pointer to an array of 3 elements, that will be filled with the sensor data. </p>
<p>For the LSM6DSL sensor, we can grab the accelerometer or gyroscope data. Here we grab the accelerometer data. </p>
<pre><code class="cpp hljs"><span class=hljs-type >int32_t</span> acc_data[<span class=hljs-number >3</span>];
AccGyr-&gt;<span class=hljs-built_in >Get_X_Axes</span>(acc_data);</code></pre>
<p>The same concept applies to the other sensor libraries as well. </p>
<h2 id=ii_gyroscope_lsm6dsl ><a href="#ii_gyroscope_lsm6dsl" class=header-anchor >II. <strong>Gyroscope LSM6DSL</strong></a></h2>
<p>Compile and run <code>mainE2GYRO.cpp</code>. Observe the data from the terminal and rotate the board with different angular rotation rates, and observe the values. You can change the delay value in the code to reduce the rate at which data is being printed.</p>
<h2 id=iii_magnetometer_lsm303agr ><a href="#iii_magnetometer_lsm303agr" class=header-anchor >III. <strong>Magnetometer LSM303AGR</strong></a></h2>
<p>Compile and run <code>mainE3MAG.cpp</code> and observe the output values on the terminal. The values should be printed in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>G</mi><mi>a</mi><mi>u</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">mGauss</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">G</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span></span></span></span>. Rotate the board in Yaw motion and align the front of the board with magnetic north direction and note the x-axis Magnetometer value. Use a compass app on your phone to compare. Then with the board front pointing North, pitch the board up and down and notice the Magnetometer x-axis value. You will notice that even though the x-axis is in the same plane along the north direction, the value changes.</p>
<p>To maintain the correct compass reading when you pitch the sensor, you need to employ the accelerometer data and peform Tilt Compensation. This is done when using magnetometers in devices that rotate in 3D space such as multirotors. </p>
<h2 id=iv_pressure_lps22hb_temperature_and_humidity_hts221 ><a href="#iv_pressure_lps22hb_temperature_and_humidity_hts221" class=header-anchor >IV. <strong>Pressure</strong> <strong>LPS22HB, Temperature and Humidity HTS221</strong></a></h2>
<p>Compile and run <code>mainE4BAR.cpp</code> and <code>mainE5HUMTEMP.cpp</code> to observe the pressure and, temperature and humidity, respectively. Pressure is provided in units of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>P</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">hPa</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">a</span></span></span></span>, temperature in <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mi>o</mi></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">^oC</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord ><span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> and humidity in relative <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >%</mi></mrow><annotation encoding="application/x-tex">\%</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.80556em;vertical-align:-0.05556em;"></span><span class=mord >%</span></span></span></span>.</p>
<p>Move the board up and down a different of at least one meter difference and observe the change in values Place your finger on the Humidity and Temperature chip, and observe he change in temperature and humidity.</p>
<h2 id=v_logging_data_to_text_file ><a href="#v_logging_data_to_text_file" class=header-anchor ><strong>V. Logging Data to Text File</strong></a></h2>
<p>A MATLAB function and script are provided under <code>scripts</code> folder which you can use to log the sensor data through the terminal. Ensure that the serial terminal is closed on VSCode, and in MATLAB. Inspect <code>LogIKS01A02.m</code> and run it to log sensor data. Note that the latter script calls the function DataLog, you can pass different port, baudrate, # of samples and output file name.</p>
<div class=page-foot >
  <div class=copyright >
    &copy; Ali AlSaibie, PhD. Last modified: June 06, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div>