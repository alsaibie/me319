<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/me319/libs/highlight/github.min.css"> <link rel=stylesheet  href="/me319/css/franklin.css"> <link rel=stylesheet  href="/me319/css/poole_hyde.css"> <link rel=stylesheet  href="/me319/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 968px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/me319/assets/c.svg"> <title>Lab 4 - Timers and Interrupts</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <br> <img src="/me319/assets/KuwaitUniversityLogoTextLight.svg" style="width: 200px; height: auto; display: inline"> <h1 style="font-size:2em; opacity: 0.75;"><a href="/me319/">ME 319</a></h1> <p class=lead >Mechatronics</p> </div> <script> function hidePart(part_div) { var x = document.getElementById(part_div); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/me319/">Home</a> <a class="sidebar-nav-item " href="/me319/videos/">Lecture Videos</a> <a class="sidebar-nav-item " href="https://alsaibie.github.io/embedded_ccpp">Embedded C/C++ Mini-Course</a> <a class="sidebar-nav-item " href="/me319/lab_assignments/">Lab Assignments</a> <br> <small style="text-transform: uppercase; font-size: 0.75em">Lab Lessons</small> <div class=part  onclick="hidePart('prelabs_div')">Prelabs</div> <div id=prelabs_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabs/prelab2/"><b>Lab 2</b> - <em>PlatformIO and Arduino</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab3/"><b>Lab 3</b> - <em>Debugging and LL Programming</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab4/"><b>Lab 4</b> - <em>Timers and Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab5/"><b>Lab 5</b> - <em>Serial Communication</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab6/"><b>Lab 6</b> - <em>Offline Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab7/"><b>Lab 7</b> - <em>Online Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab8/"><b>Lab 8</b> - <em>Motor Dynamics and Control</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab9/"><b>Lab 9</b> - <em>Realtime Motor Control</em></a> </div> <div class=part  onclick="hidePart('addlessons_div')">Additional Lessons</div> <div id=addlessons_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabsextra/lab4extra/"> <b>L4E</b> - <em>Low Level Timers Configuration</em></a> </div> <br> <small style="text-transform: uppercase; font-size: 0.75em">Class Lectures</small> <div class=part  onclick="hidePart('part1_div')">I The Brain</div> <div id=part1_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_i/lecture0/"><b>L0</b> - <em>Introduction</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture1/"><b>L1</b> - <em>Microcontroller Architecture</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture2/"><b>L2</b> - <em>Digital Arithmetic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture3/"><b>L3</b> - <em>Digital Logic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture4/"><b>L4</b> - <em>Microcontroller Peripherals</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture5/"><b>L5</b> - <em>GPIO</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture6/"><b>L6</b> - <em>Timers</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture7/"><b>L7</b> - <em>Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture8/"><b>L8</b> - <em>Communication</em></a> </div> <div class=part  onclick="hidePart('part2_div')">II The Cells</div> <div id=part2_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_ii/lecture1/"><b>L1</b> - <em>Passive Circuits</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture2/"><b>L2</b> - <em>Switching Semiconductors</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture3/"><b>L3</b> - <em>Operational Amplifiers</em></a> </div> <div class=part  onclick="hidePart('part3_div')">III The Senses</div> <div id=part3_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iii/lecture1/"><b>L1</b> - <em>Signal Conditioning and Filtering</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture2/"><b>L2</b> - <em>Sensor Charactersitics</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture3/"><b>L3</b> - <em>Survey of Sensors</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture4/"><b>L4</b> - <em>Motion Sensors</em></a> </div> <div class=part  onclick="hidePart('part4_div')">IV The Muscles</div> <div id=part4_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iv/lecture1/"><b>L1</b> - <em>DC Motors</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture2/"><b>L2</b> - <em>Practical Feedback Control</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture4/"><b>L3</b> - <em>Stepper Motors</em></a> </div> <div class=part  onclick="hidePart('part5_div')">V The Body</div> <div id=part5_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_v/lecture1/"><b>L1</b> - <em>System Integration</em></a> </div> </nav> <p>&copy; Ali AlSaibie, PhD.</p> </div> </div> <div class="content container"> <div class=franklin-content ><h1 id=lab_4_-_timers_and_interrupts ><a href="#lab_4_-_timers_and_interrupts" class=header-anchor >Lab 4 - Timers and Interrupts</a></h1> <h2 id=overview ><a href="#overview" class=header-anchor >Overview</a></h2> <p>In this assignment you will be practicing setting up timers and interrupts.</p> <p>Before attempting this assignment, make sure you go through the <a href="/me319/prelabs/prelab4/">Prelab 4</a> document first.</p> <h2 id=tools_required ><a href="#tools_required" class=header-anchor >Tools Required</a></h2> <ul> <li><p>VSCode with PlatformIO Extension</p> <li><p>STM32 Nucleo F401RE Board </p> <li><p>USB Type A to USB Mini-B Connector</p> </ul> <h2 id=references ><a href="#references" class=header-anchor >References</a></h2> <ol> <li><p><a href="/me319/assets/reference_docs/REF03_STM32_Nucleo-64_boards_User_Manual.pdf">REF03 STM32 Nucleo-64 boards User Manual</a></p> <li><p><a href="/me319/assets/assets/reference_docs/REF01_STM32F401RE_DATASHEET.pdf">REF01 STM32F401RE Datasheet</a></p> <li><p><a href="/me319/assets/reference_docs/REF02_STM32F401xBC_and_STM32F401xDE_Reference_Manual.pdf">REF02 STM32F401RE Reference Manual</a></p> <li><p>Lab Report Submission Guidelines</p> <li><p><a href="/me319/prelabs/prelab4/">ME319 Prelab 4</a></p> </ol> <h2 id=project_creation_submission ><a href="#project_creation_submission" class=header-anchor >Project Creation &amp; Submission</a></h2> <p>For this assignment, it is suggested that you create a single project with multiple <code>main*.cpp</code> files, inside the <code>src</code> folder, for each question below.</p> <p>You only need to submit the &#40;<code>mainQ1.cpp</code>, <code>mainQ2.cpp</code>, etc&#41; files for this assignment.</p> <p>To have one project with multiple source files, where you only compile one at a time, you need to configure platformio.ini to only compile the file you want. Replace the content of the platformio.ini with this, then change mainQ1.cpp to the file name you wish to compile. The last line &#40;src_filter&#41; basically tells the platformio configurator to remove all <code>main*.cpp</code> from the compile list, then add only the specific mainQ1.cpp file. If we don&#39;t add this filter line, all the files inside the folder <code>src</code> will be compiled.</p> <pre><code class="ini hljs"><span class=hljs-section >[env:nucleo_f401re]</span>
<span class=hljs-attr >platform</span> = ststm32
<span class=hljs-attr >board</span> = nucleo_f401re
<span class=hljs-attr >framework</span> = ardui<span class=hljs-literal >no</span>
<span class=hljs-attr >src_filter</span> = -&lt;main*.cpp&gt; +&lt;mainQ1.cpp&gt;</code></pre> <h2 id=questions ><a href="#questions" class=header-anchor >Questions</a></h2> <h3 id=pwm_sweep ><a href="#pwm_sweep" class=header-anchor ><ol> <li><p>PWM Sweep</p> </ol> </a></h3> <p>For this task you need to create 2 timers, one periodic and one for generating a PWM signal.</p> <p>On the STM32F401x there are 8 timers. You can choose any timer to be the source of the periodic callback, but you can only choose specific timers for generating PWM signals, depending on the timers&#39; capability and depending on the output pins available for use.</p> <p> <center><img src="/me319/labs/l4media/Table4DatasheetTimerFeatures.svg" style="max-width:780px"></center> </p> <p>We want to use the PWM signal to control the built-in LED, PA5, which can only be connected to Channel 1 of TIM2 &#40;other pins may be connected to either of two channels of two timers&#41;. <center><img src="/me319/labs/l4media/Table9Datasheet_AltFunctions.svg" style="max-width:780px"></center> </p> <p>Following the examples from prelab 4. Create a periodic timer to execute a callback function @ 5Hz and setup another timer to generate a PWM signal on the LED pin &#40;PA5&#41;.</p> <p>In the periodic callback function perform the following routine:</p> <p>Sweep up/down/up/down and repeate the duty cycle of the PWM signal. In other words, increment the duty cycle of the PWM signal by small increments at every callback call to the periodic interrupt, from 0 to 100, then decrement from 100 to 0 and repeat.</p> <p>Experiment with different PWM increment/decrement values and different periodic function callback frequency, in order to observe a gradual change of brightness of the LED as you sweep the duty cycle.</p> <p>Note: You need to make the pwm timer instance global so you can access it in the setup&#40;&#41; and callback functions. See the TimerIC example in Example 3 of Prelab 4.</p> <h3 id=ol_start2_gpio_interrupt ><a href="#ol_start2_gpio_interrupt" class=header-anchor ><ol start=2 > <li><p>GPIO Interrupt</p> </ol> </a></h3> <p>Create a GPIO event interrupt to count the number of times the user button is pressed inside the interrupt callback function. Also print to the serial stream the latest count value.</p> <p>Also program a routine that would reset the press count value, if the button was pressed for longer than 2 seconds. </p> <p>Hint: Once you enter the interrupt callback function, put a while loop to keep track of the time elapsed while the button remains pressed, so either the button is un-pressed or more than 2 seconds have passed. You can use the Arduino function millis&#40;&#41; that would return the time elapsed in milliseconds since the MCU had booted.</p> <p>If the counter value was reset, print to the serial stream that the reset occurred.</p> <p>For the counter variable, use a static variable inside the callback function.</p> <div class=page-foot > <div class=copyright > &copy; Ali AlSaibie, PhD. Last modified: June 02, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div>