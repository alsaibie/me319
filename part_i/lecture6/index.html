<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/me319/libs/katex/katex.min.css"> <link rel=stylesheet  href="/me319/libs/highlight/github.min.css"> <link rel=stylesheet  href="/me319/css/franklin.css"> <link rel=stylesheet  href="/me319/css/poole_hyde.css"> <link rel=stylesheet  href="/me319/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 968px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/me319/assets/c.svg"> <title>Part I L6 - Timers</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <br> <img src="/me319/assets/KuwaitUniversityLogoTextLight.svg" style="width: 200px; height: auto; display: inline"> <h1 style="font-size:2em; opacity: 0.75;"><a href="/me319/">ME 319</a></h1> <p class=lead >Mechatronics</p> </div> <script> function hidePart(part_div) { var x = document.getElementById(part_div); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/me319/">Home</a> <a class="sidebar-nav-item " href="/me319/videos/">Lecture Videos</a> <a class="sidebar-nav-item " href="https://alsaibie.github.io/embedded_ccpp">Embedded C/C++ Mini-Course</a> <a class="sidebar-nav-item " href="/me319/lab_assignments/">Lab Assignments</a> <br> <small style="text-transform: uppercase; font-size: 0.75em">Lab Lessons</small> <div class=part  onclick="hidePart('prelabs_div')">Prelabs</div> <div id=prelabs_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabs/prelab2/"><b>Lab 2</b> - <em>PlatformIO and Arduino</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab3/"><b>Lab 3</b> - <em>Debugging and LL Programming</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab4/"><b>Lab 4</b> - <em>Timers and Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab5/"><b>Lab 5</b> - <em>Serial Communication</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab6/"><b>Lab 6</b> - <em>Offline Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab7/"><b>Lab 7</b> - <em>Online Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab8/"><b>Lab 8</b> - <em>Motor Dynamics and Control</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab9/"><b>Lab 9</b> - <em>Realtime Motor Control</em></a> </div> <div class=part  onclick="hidePart('addlessons_div')">Additional Lessons</div> <div id=addlessons_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabsextra/lab4extra/"> <b>L4E</b> - <em>Low Level Timers Configuration</em></a> <a class="sidebar-nav-item " href="/me319/prelabsextra/kalmanfilter/"> <b>L6E</b> - <em>Kalman Filter</em></a> </div> <br> <small style="text-transform: uppercase; font-size: 0.75em">Class Lectures</small> <div class=part  onclick="hidePart('part1_div')">I The Brain</div> <div id=part1_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_i/lecture0/"><b>L0</b> - <em>Introduction</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture1/"><b>L1</b> - <em>Microcontroller Architecture</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture2/"><b>L2</b> - <em>Digital Arithmetic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture3/"><b>L3</b> - <em>Digital Logic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture4/"><b>L4</b> - <em>Microcontroller Peripherals</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture5/"><b>L5</b> - <em>GPIO</em></a> <a class="sidebar-nav-item active" href="/me319/part_i/lecture6/"><b>L6</b> - <em>Timers</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture7/"><b>L7</b> - <em>Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture8/"><b>L8</b> - <em>Communication</em></a> </div> <div class=part  onclick="hidePart('part2_div')">II The Cells</div> <div id=part2_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_ii/lecture1/"><b>L1</b> - <em>Passive Circuits</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture2/"><b>L2</b> - <em>Switching Semiconductors</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture3/"><b>L3</b> - <em>Operational Amplifiers</em></a> </div> <div class=part  onclick="hidePart('part3_div')">III The Senses</div> <div id=part3_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iii/lecture1/"><b>L1</b> - <em>Signal Conditioning and Filtering</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture2/"><b>L2</b> - <em>Sensor Charactersitics</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture3/"><b>L3</b> - <em>Survey of Sensors</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture4/"><b>L4</b> - <em>Motion Sensors</em></a> </div> <div class=part  onclick="hidePart('part4_div')">IV The Muscles</div> <div id=part4_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iv/lecture1/"><b>L1</b> - <em>DC Motors</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture2/"><b>L2</b> - <em>Practical Feedback Control</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture4/"><b>L3</b> - <em>Stepper Motors</em></a> </div> <div class=part  onclick="hidePart('part5_div')">V The Body</div> <div id=part5_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_v/lecture1/"><b>L1</b> - <em>System Integration</em></a> </div> </nav> <p>&copy; Ali AlSaibie, PhD.</p> </div> </div> <div class="content container"> <div class=franklin-content ><h1 id=part_i_l6_-_timers ><a href="#part_i_l6_-_timers" class=header-anchor >Part I L6 - Timers</a></h1> <h2 id=lecture_video ><a href="#lecture_video" class=header-anchor >Lecture Video</a></h2> <p>Part A</p> <iframe src="https://player.vimeo.com/video/542122961" width=780  height=438  frameborder=0  allowfullscreen></iframe> <p>Part B <iframe src="https://player.vimeo.com/video/543111115" width=780  height=438  frameborder=0  allowfullscreen></iframe> </p> <p><a href="/me319/part_i/ME319_-_Mechatronics_-_Part_I_Lecture_6_Timers.pdf">Lecture Handout</a></p> <p>Next: <a href="../lecture7/">Part I L7 - Interrupts</a> </p> <h2 id=objectives ><a href="#objectives" class=header-anchor >Objectives</a></h2> <ul> <li><p>Understand the fundamentals of a timer operation</p> <li><p>Overview the application of Timers </p> <li><p>Introduce Pulse Width Modulation</p> </ul> <p>Note: the timer operations reviewed in this lecture are based on the STM32F401x MCUs, but they largely apply to all MCU Timers. Names and terms may differ.</p> <h2 id=timers_-_mechanical_analogy ><a href="#timers_-_mechanical_analogy" class=header-anchor >Timers - Mechanical Analogy</a></h2> <p>This is a mechanical tick counter. <center><img src="/me319/part_i/lecture6_media/CounterReal.jpg" style="max-width:225px"></center></p> <p>Every time you click the middle button, it increments the counter by one. It continues to count up until 9999 then resets, mechanically, to 0000. Now, replace the mechanical counter by a memory register, and replace the button-clicking-action by an electronic pulse. You now have a digital timer. The size of the counter register &#40;# of bits&#41; and pulse rate: Determine the speed of the count and the reset rate.</p> <h3 id=example ><a href="#example" class=header-anchor >Example</a></h3> <p>If you have an 8bit counter; a counter that counts from 0 to 255 then resets to 0. And you are counting up at a rate of 20Hz. How long does it take for you to count from 0 to 255?</p> <h2 id=timers_in_microcontrollers ><a href="#timers_in_microcontrollers" class=header-anchor >Timers in microcontrollers</a></h2> <p>In the context of an MCU, a timer counts <strong>up</strong> or <strong>down</strong>, either at a specific rate <strong>or</strong> in response to an event.</p> <p>The timer count is stored in a memory register &#40;8, 16, 32bit registers&#41;. A 16-bit timer will count <strong>up</strong> from 0x0000 to 0xFFFF, then rollover to 0x0000. Or it can count down from 0xFFFF to 0x0000 and rollover to 0xFFFF. </p> <p>The timer can also be configured to rollover at a specific value &#40;or start from one&#41;. For example, it can be configured to count to 0xF0E5, then rollover back to 0x0000.</p> <p>When an MCU has multiple timer peripherals, usually, every timer peripheral can be independently set. The rate of the count can be independently set, the range of the count, the mode and whether it counts up or down, each can be set independently for each timer peripheral.</p> <p>A timer increments &#40;decrements&#41; in response to a pulse&quot; Rising Edge, Falling Edge, or Both</p> <p>The pulse can come from a clock source, which can be scaled &#40;prescaler&#41;, or from an event signal &#40;e.g. an external button press, encoder, modulated signal&#41;. <center><img src="/me319/part_i/lecture6_media/TimerBasic.svg" style="max-width:780px"></center></p> <h3 id=example__2 ><a href="#example__2" class=header-anchor >Example</a></h3> <p>We would like to have a timer rollover every <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi>m</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">10ms</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span><span class=mord >0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span></span>. If the timer is running at <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mi>M</mi><mi>H</mi><mi>z</mi></mrow><annotation encoding="application/x-tex">100MHz</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span> &#40;count rate&#41;, what should be the starting count value &#40;timer in count-down mode&#41;.</p> <h2 id=what_are_timers_good_for ><a href="#what_are_timers_good_for" class=header-anchor >What are timers good for?</a></h2> <p>Using timers, we can</p> <ol> <li><p>Keep track of elapsed time, or wait for a specific amount of time</p> <ul> <li><p><em>E.g. When you call delay&#40;500&#41;; a timer peripheral is used</em></p> </ul> <li><p>Call a function at a specific and deterministic rate</p> <ul> <li><p><em>E.g. Essential in applied control systems</em></p> </ul> <li><p>Generate a signal with a specific frequency &amp; on/off time ratio</p> <ul> <li><p><em>E.g. Generate a square wave, PWM or PPM signal</em></p> </ul> <li><p>Record the time when an external or internal event occurred </p> <ul> <li><p><em>E.g. Register the frequency of a square wave signal</em></p> </ul> </ol> <p>Let’s look at how each one is achieved...</p> <p>An 8-bit count-down timer, can be configured to count from a maximum value of 0xFF. Termed the <strong>autoload</strong> value, since the MCU will <strong>load</strong> it onto counter at <strong>rollover</strong> <center><img src="/me319/part_i/lecture6_media/GeneralTimerCountDown.svg" style="max-width:780px"></center> Rollover frequency is defined as:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>f</mi><mrow><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>f</mi><mrow><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></msub><mrow><mi>A</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>L</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">f_{rollover} = \dfrac{f_{count}}{AutoLoadValue}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.0574399999999997em;vertical-align:-0.686em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">L</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>Rollover period is defined as:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>T</mi><mrow><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><msub><mi>f</mi><mrow><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>r</mi></mrow></msub></mfrac><mo>=</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>×</mo><mi>A</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>L</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">T_{rollover}=\dfrac{1}{f_{rollover}}=T_{count}\times AutoLoadValue</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.20188em;vertical-align:-0.8804400000000001em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.32144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">L</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span></span></span></span></span> <h2 id=timer_modes ><a href="#timer_modes" class=header-anchor >Timer Modes</a></h2> <p>There are several modes a timer can be configured for</p> <ol> <li><p>Periodic Timer: Internal MCU use</p> <li><p>Input Capture: Records when an external input event occurred</p> <li><p>Output Compare: Generates an external output waveform</p> </ol> <p>Additional modes can be found on MCUs, but they are usually an extension of the above. In each of these modes, there is always a counter incrementing/decrementing at a specific rate, but their purpose and use are different. Timers, just like other peripherals, operate independently from the CPU. There is no CPU overhead from using timers; except for when accessing timer data.</p> <h2 id=period_timer_mode ><a href="#period_timer_mode" class=header-anchor ><ol> <li><p>Period Timer Mode</p> </ol> </a></h2> <p>When used as a general, or periodic, timer, it is a count up/down timer, and counting is done at a set rate.</p> <p>The timer can be configured to generate a timed interrupt INT &#40;interrupt CPU at a specific rate&#41; when rollover is occurs if counting up, or when it reaches 0x0000 if counting down.</p> <p>One usage for example would be to configure a timer &#40;rate, count range&#41; to issue an INT at every rollover, then tie this INT to a specific function call. Now you have a periodic function call, use it to control a robot motor for instance. </p> <p>The timer can also be checked &#40;polled&#41; by the program. One usage example is to configure a timer to run freely and when you want to delay&#40;500ms&#41;, you go and take a reading of the timer, and based on the count rate of that timer, wait for a number of counts &#40;keep checking the timer&#41; to occur that would result in 500ms to have passed, then return, effectively pausing the program for 500ms.</p> <h2 id=ol_start2_input_capture_mode ><a href="#ol_start2_input_capture_mode" class=header-anchor ><ol start=2 > <li><p>Input Capture Mode</p> </ol> </a></h2> <p>In Input Capture mode, you have a timer running with a certain configuration &#40;rate, range, direction&#41;, plus, it monitors for an external input event via a pin &#40;Rising Edge, Falling or Both&#41;. </p> <p>When an event occurs, the timer peripheral makes a copy of the count value in the timer register and stores it in a second memory register. This latter register will store the count value of timer for when an event was last detected &#40;or it can be configured to not override that value until the program has read it first&#41;.</p> <p>The timer in input capture mode can also issue an Interrupt to CPU saying “Hey Boss, an event occurred, come down and read the count value for when it occurred” or the interrupt can be tied to calling a certain function. </p> <p>With this setup you can measure frequency of an input signal for example. By recording the count values for two consecutive signal events, subtract difference and convert to time or frequency.</p> <p>Note that the timer counter it self keeps running uninterrupted, when an event occurs, a snapshot of the counter value is stored in a different register. <center><img src="/me319/part_i/lecture6_media/InputCaptureTimer.svg" style="max-width:780px"></center></p> <p>A timer in Input Capture Mode is used with rotary encoders which are sensors for measuring angular position. By measuring the number of events of this encoder signal we can measure the angular position of a knob or motor, and by measuring the frequency of this signal we can directly measure the angular velocity. More on encoders in later parts of the course. <center><img src="/me319/part_i/lecture6_media/EncoderInputCapture.svg" style="max-width:980px"></center></p> <h3 id=example__3 ><a href="#example__3" class=header-anchor >Example</a></h3> <p>Given the following Timer Configuration. If the detection mode is on Both Edges &#40;Rising and Falling&#41;. What is the counter value when the edge detection occurs. Assume the counter restarts every time an edge is detected.</p> <center><img src="/me319/part_i/lecture6_media/InputCaptureTimerExample.svg" style="max-width:780px"></center> <h2 id=ol_start3_output_compare_mode ><a href="#ol_start3_output_compare_mode" class=header-anchor ><ol start=3 > <li><p>Output Compare Mode</p> </ol> </a></h2> <p>In Output Compare, you have a timer running with a certain configuration &#40;rate, range, direction&#41;, plus a fixed value to compare the count value of the timer with. </p> <p>For example to general a PWM signal which, at the beginning of the period is set high, then somewhere in the middle before the period is ended, the signal is set low. The timer in output compare mode is set such that At the beginning of the count or at rollover, the GPIO output pin is set high. Then when the counter reaches the compare value, the GPIO output pin value is cleared. With this you can create a a variable width pulse &#40;PWM&#41; where the Autoload Value determines signal freq &#40;period&#41;, and the compare value determines the duty cycle. </p> <p>To general a variable frequency signal &#40;Square Wave&#41; the Autoload Value will be set to determine the signal freq, and the compare value is set as <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace linebreak=newline ></mspace><mi>d</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mn>12</mn></mrow><annotation encoding="application/x-tex">\\dfrac{1}{2}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class="mspace newline"></span><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class=mord ><span class=mord >1</span></span><span class=mord ><span class=mord >2</span></span></span></span></span> autoload value.</p> <center><img src="/me319/part_i/lecture6_media/TimerOutputCompare.svg" style="max-width:780px"></center> <p>By selecting the range &#40;autoload value&#41; in the counter, the count rate and the compare value an output signal can be designed and generated.</p> <h3 id=example__4 ><a href="#example__4" class=header-anchor >Example</a></h3> <p>Given the following timer configuration. What should be the autoload value for the 16-bit down counter, and the compare value. In order to generate a 100kHz square wave signal. </p> <center><img src="/me319/part_i/lecture6_media/TimerOutputCompareExample.svg" style="max-width:780px"></center> <h2 id=pulse_width_modulation_pwm ><a href="#pulse_width_modulation_pwm" class=header-anchor >Pulse Width Modulation &#40;PWM&#41;</a></h2> <p>When we have an analog input to the microcontroller, we can use the ADC to convert to digital, but how about going the other way? Say we want to vary the output voltage to control the brightness of an LED, or the speed of a motor? Microcontrollers work in 1’s and 0’s, how can we achieve a value in between? How can we emulate an analog signal?</p> <p>The options for emulating an analog signal are:</p> <ul> <li><p>DAC: Digital to Analog Conversion &#40;Computationally costly&#41;</p> <li><p>PWM: Pulse Width Modulation &#40;Simple and easy&#41;</p> </ul> <p>What makes a PWM usable as an emulated analog signal is that many systems &#40;electromechanical specifically&#41; have a low pass filter characteristic to high frequency signals. The don&#39;t respond as fast as the signal, they react to the average value of the signal instead. </p> <p>A variable signal can be generated with one output <br> <center><img src="/me319/part_i/lecture6_media/PWM_AC_DC.svg" style="max-width:780px"></center> In fact, a PWM with an external Low Pass Filter circuit can perform DAC <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_LP_DC.svg" style="max-width:780px"></center></p> <p>Usually with PWM signals, the frequency is fixed for the application, and what is varied is the duty cycle or &quot;pulse width&quot;, hence the name Pulse Width Modulation. Modulation meaning being changed/varied.</p> <p>There are three parameters that define a PWM signal:</p> <ol> <li><p>Pulse Width &#40;also known as duty cycle&#41;</p> <li><p>Period &#40;Frequency&#41;</p> <li><p>Voltage</p> </ol> <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_Anatomy.svg" style="max-width:580px"></center> <p>Duty Cycle &#40;or pulse width, but pulse width is defined in time units&#41; is the percentage of time the signal is HIGH &#40;or LOW for inverted logic&#41;. <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_DutyCycles.svg" style="max-width:580px"></center></p> <h2 id=pwm_frequency ><a href="#pwm_frequency" class=header-anchor >PWM Frequency</a></h2> <p>A PWM signal has a fixed frequency that is independent of the duty cycle. The frequency is configured to be a specific value based on the application. </p> <p> <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_DutyCyclesHorizontal.svg" style="max-width:980px"></center> A PWM signal can be generated using a digital output pin by rapidly setting pin high/low &#40;PWM with 50&#37; Duty Cycle &#61;&gt; square wave signal&#41;</p> <h3 id=pwm_frequency_range ><a href="#pwm_frequency_range" class=header-anchor >PWM Frequency Range</a></h3> <p>The PWM frequency must be high enough for the AC component to be suppressed by the driven system. This depends on the system being commanded the PWM signal. Also, for driving coils/windings, humming can occur for frequencies in the audible range. So aim for <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>25</mn><mi>k</mi><mi>H</mi><mi>z</mi></mrow><annotation encoding="application/x-tex">&gt;25kHz</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class=mrel >&gt;</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class=mord >2</span><span class=mord >5</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span>. But too high frequencies are not recommended, as high frequencies result in high switching rates of semiconductors, and if semiconductors are switched at a high rate, they become less efficient &#40;energy loss&#41;. Finally, avoid resonant frequencies of the driven system. For example, don&#39;t command a motor with a PWM signal that has a frequency that matches the motors resonant frequency. <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_Anatomy.svg" style="max-width:580px"></center></p> <h3 id=example__5 ><a href="#example__5" class=header-anchor >Example</a></h3> <p>What is the voltage of the PWM signal below, averaged over 1 cycle? <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_AverageExample.svg" style="max-width:580px"></center></p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>V</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mfrac><mrow><mo stretchy=false >(</mo><mn>5</mn><mi>V</mi><mo stretchy=false >)</mo><mo stretchy=false >(</mo><mn>20</mn><mi>m</mi><mi>s</mi><mo stretchy=false >)</mo><mo>+</mo><mo stretchy=false >(</mo><mn>0</mn><mi>V</mi><mo stretchy=false >)</mo><mo stretchy=false >(</mo><mn>80</mn><mi>m</mi><mi>s</mi><mo stretchy=false >)</mo></mrow><mrow><mn>100</mn><mi>m</mi><mi>s</mi></mrow></mfrac><mo>=</mo><mn>1</mn><mi>V</mi></mrow><annotation encoding="application/x-tex">V_{avg}=\dfrac{(5V)(20ms)+(0V)(80ms)}{100ms}=1V</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.113em;vertical-align:-0.686em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.427em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mopen >(</span><span class=mord >5</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=mclose >)</span><span class=mopen >(</span><span class=mord >2</span><span class=mord >0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mopen >(</span><span class=mord >0</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=mclose >)</span><span class=mopen >(</span><span class=mord >8</span><span class=mord >0</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >1</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>V</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mo stretchy=false >(</mo><mi>D</mi><mi>u</mi><mi>t</mi><mi>y</mi><mtext> </mtext><mi>C</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo stretchy=false >)</mo><mo>×</mo><msub><mi>V</mi><mrow><mi>d</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{avg}=(Duty\,Cycle)\times V_{dd}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <h3 id=pwm_to_drive_a_dc_motor ><a href="#pwm_to_drive_a_dc_motor" class=header-anchor >PWM to Drive a DC Motor</a></h3> <p>Here is a simple example, where a pwm signal is generated by the microcontroller to switch the MOSFET and close the motor circuit on/off rapidly. The duty cycle will determine the average voltage sent to the motor, the motor speed is proportional to this average voltage achieved by the PWM signal. Remember that a MOSFET here acts like a water valve, the PWM signal simply controls the lever, electrons flowing through the motor are like water passing through a pipe and watermill. This circuit only controls the motor speed in one direction. To control the motor in two directions an expanded circuit is needed, we will cover this in later parts of the course. </p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>V</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mo stretchy=false >(</mo><mi>D</mi><mi>u</mi><mi>t</mi><mi>y</mi><mtext> </mtext><mi>C</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo stretchy=false >)</mo><mo>×</mo><msub><mi>V</mi><mrow><mi>d</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{avg}=(Duty\,Cycle)\times V_{dd}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <br><br> <center><img src="/me319/part_i/lecture6_media/PWM_Motor_Single_Direction.svg" style="max-width:480px"></center> <h2 id=pwm_on_stm32f401x ><a href="#pwm_on_stm32f401x" class=header-anchor >PWM on STM32F401x</a></h2> <p>On the STM32F401x family of microcontrollers there is a dedicated PWM functionality on timer peripherals, as well as a dedicated PWM module separate from Timer peripherals. </p> <h3 id=pwm_using_timer_module ><a href="#pwm_using_timer_module" class=header-anchor >PWM using Timer Module</a></h3> <ul> <li><p>Simple Implementation</p> <li><p>Using Output Compare Principle</p> <li><p>32-bit or 16-bit timer</p> </ul> <h3 id=pwm_using_pwm_module ><a href="#pwm_using_pwm_module" class=header-anchor >PWM Using PWM Module</a></h3> <ul> <li><p>Provides PWM on all timers/channels</p> <li><p>On Advanced Control Timer 1</p> <ul> <li><p>Combined in single action or complementary pairs</p> <li><p>Provide Dead-band delays &#40;prevents shoot through; shorting&#41;</p> <li><p>Timer synchronization of PWM blocks</p> <li><p>16-bit timer</p> </ul> </ul> <p>The STM32F401RE has up to 11 timers <br><br> <center><img src="/me319/part_i/lecture6_media/Table4DatasheetTimerFeatures.svg" style="max-width:980px"></center></p> <p>Timers interface with pins through channels. On STM32F4x, a timer has up to four channels. There is a specific pin associated with each channel and a pin might be associated to more than one timer. For Example: Look at PA2 and PA3 in the following table. <br><br> <center><img src="/me319/part_i/lecture6_media/Table9Datasheet_AltFunctions_P0P3.svg" style="max-width:980px"></center></p> <div class=page-foot > <div class=copyright > &copy; Ali AlSaibie, PhD. Last modified: June 26, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div>