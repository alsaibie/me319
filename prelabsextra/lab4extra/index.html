<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/me319/libs/katex/katex.min.css"> <link rel=stylesheet  href="/me319/libs/highlight/github.min.css"> <link rel=stylesheet  href="/me319/css/franklin.css"> <link rel=stylesheet  href="/me319/css/poole_hyde.css"> <link rel=stylesheet  href="/me319/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 968px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/me319/assets/c.svg"> <title>Lab 4 Extra - Low Level Timers Configuration</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <br> <img src="/me319/assets/KuwaitUniversityLogoTextLight.svg" style="width: 200px; height: auto; display: inline"> <h1 style="font-size:2em; opacity: 0.75;"><a href="/me319/">ME 319</a></h1> <p class=lead >Mechatronics</p> </div> <script> function hidePart(part_div) { var x = document.getElementById(part_div); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/me319/">Home</a> <a class="sidebar-nav-item " href="/me319/videos/">Lecture Videos</a> <a class="sidebar-nav-item " href="https://alsaibie.github.io/embedded_ccpp">Embedded C/C++ Mini-Course</a> <a class="sidebar-nav-item " href="/me319/lab_assignments/">Lab Assignments</a> <br> <small style="text-transform: uppercase; font-size: 0.75em">Lab Lessons</small> <div class=part  onclick="hidePart('prelabs_div')">Prelabs</div> <div id=prelabs_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabs/prelab2/"><b>Lab 2</b> - <em>PlatformIO and Arduino</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab3/"><b>Lab 3</b> - <em>Debugging and LL Programming</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab4/"><b>Lab 4</b> - <em>Timers and Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab5/"><b>Lab 5</b> - <em>Serial Communication</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab6/"><b>Lab 6</b> - <em>Offline Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab7/"><b>Lab 7</b> - <em>Online Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab8/"><b>Lab 8</b> - <em>Motor Dynamics and Control</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab9/"><b>Lab 9</b> - <em>Realtime Motor Control</em></a> </div> <div class=part  onclick="hidePart('addlessons_div')">Additional Lessons</div> <div id=addlessons_div  style="display:none;"> <a class="sidebar-nav-item active" href="/me319/prelabsextra/lab4extra/"> <b>L4E</b> - <em>Low Level Timers Configuration</em></a> <a class="sidebar-nav-item " href="/me319/prelabsextra/kalmanfilter/"> <b>L6E</b> - <em>Kalman Filter</em></a> </div> <br> <small style="text-transform: uppercase; font-size: 0.75em">Class Lectures</small> <div class=part  onclick="hidePart('part1_div')">I The Brain</div> <div id=part1_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_i/lecture0/"><b>L0</b> - <em>Introduction</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture1/"><b>L1</b> - <em>Microcontroller Architecture</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture2/"><b>L2</b> - <em>Digital Arithmetic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture3/"><b>L3</b> - <em>Digital Logic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture4/"><b>L4</b> - <em>Microcontroller Peripherals</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture5/"><b>L5</b> - <em>GPIO</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture6/"><b>L6</b> - <em>Timers</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture7/"><b>L7</b> - <em>Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture8/"><b>L8</b> - <em>Communication</em></a> </div> <div class=part  onclick="hidePart('part2_div')">II The Cells</div> <div id=part2_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_ii/lecture1/"><b>L1</b> - <em>Passive Circuits</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture2/"><b>L2</b> - <em>Switching Semiconductors</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture3/"><b>L3</b> - <em>Operational Amplifiers</em></a> </div> <div class=part  onclick="hidePart('part3_div')">III The Senses</div> <div id=part3_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iii/lecture1/"><b>L1</b> - <em>Signal Conditioning and Filtering</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture2/"><b>L2</b> - <em>Sensor Charactersitics</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture3/"><b>L3</b> - <em>Survey of Sensors</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture4/"><b>L4</b> - <em>Motion Sensors</em></a> </div> <div class=part  onclick="hidePart('part4_div')">IV The Muscles</div> <div id=part4_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iv/lecture1/"><b>L1</b> - <em>DC Motors</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture2/"><b>L2</b> - <em>Practical Feedback Control</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture4/"><b>L3</b> - <em>Stepper Motors</em></a> </div> <div class=part  onclick="hidePart('part5_div')">V The Body</div> <div id=part5_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_v/lecture1/"><b>L1</b> - <em>System Integration</em></a> </div> </nav> <p>&copy; Ali AlSaibie, PhD.</p> </div> </div> <div class="content container"> <div class=franklin-content ><h1 id=lab_4_extra_-_low_level_timers_configuration ><a href="#lab_4_extra_-_low_level_timers_configuration" class=header-anchor >Lab 4 Extra - Low Level Timers Configuration</a></h1> <p>In this lesson we will review how timers are configured through direct register access and how the STM32Cube HAL can be used to configure timers. Specifically, you will learn how to:</p> <ol> <li><p>Setup a periodic timer to toggle a pin connected to an LED</p> <li><p>Setup a timer peripheral to generate a PWM signal on the LED pin using the PWM Module</p> <li><p>Use the STM32Cube HAL to generate a PWM signal</p> </ol> <h2 id=example_1_led_toggle_via_a_periodic_timer ><a href="#example_1_led_toggle_via_a_periodic_timer" class=header-anchor >Example 1: LED Toggle via a Periodic Timer</a></h2> <p>In this example, a timer will be configured to generate an interrupt at a fixed frequency. The interrupt will have an interrupt handler &#40;a callback function&#41; which will toggle the pin connected to the LED. Let&#39;s see how this can be done without using any libraries. </p> <h3 id=gpio_configuration ><a href="#gpio_configuration" class=header-anchor >GPIO Configuration</a></h3> <p>The LED is connected to <strong>PA5</strong>, we will have to configure the pin as an output and enable the GPIO port. </p> <pre><code class="cpp hljs"><span class=hljs-comment >/* Enable GPIOA Clock */</span>
RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
<span class=hljs-comment >/* Set Port A Pin 5 as Output */</span>
GPIOA-&gt;MODER |= GPIO_MODER_MODER5_0;</code></pre> <p>For this example we can use any timer peripheral, as we are not constrained by which channel of the timer connects to which pin. We only require that a timer generates an internal event at a specific rate. We will use Timer 2.</p> <p>So next, we do the following steps </p> <ol> <li><p>Enable Timer 2 peripheral by setting <code>TIM2EN</code> bit in the <code>RCC APB1ENR</code> register. Connecting the peripheral to a beat.</p> <li><p>Based on the speed of the <code>APB1</code> bus which Timer 2 is connected on, we choose a prescaler value to bring the timer clock frequency to 20kHz. This is the rate at which the timer will count. Note that the APB1 bus clock runs at 16MHz by default. This can be increased to 42MHz if PLL is enabled on the System Clock configuration. But we will leave it as is here. To reduce the timer clock from 16MHz to 20kHz we need to divide 16Mhz by &#40;16E3 / 20E3&#41; The prescaler value, which is set in the <code>PSC</code> register would then be &#40;16E3 / 20E3&#41; -1. The minus one is required to offset the value to zero in case no division is done. </p> <li><p>We disable the timer count by clearing the <code>CEN</code> bit in <code>CR1</code> register. </p> <li><p>We reinitialize the counter and update timer registers by setting the <code>UG</code> bit in the <code>EGR</code> register.</p> <li><p>Now we just assign the Autoreload value. This autoreaload value and the timer frequency, will determine the period of the timer and thus the periodic interrupt frequency. Remember the relationship between the count period <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{count}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> which is the reciprocal of the timer count frequency &#40;20kHz in our case&#41;, the number of counts which is the autoreload value and the timer period <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{period}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> which is the duration the timer needs to count from 0 to the autoreload value &#40;in count-up mode&#41;. </p> </ol> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>T</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi></mrow></msub><mo>=</mo><mi mathvariant=normal >#</mi><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mi>s</mi><mo>×</mo><msub><mi>T</mi><mrow><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{period}=\#counts \times T_{count}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class=mord >#</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <p>If we choose an autoreload value of 1000-1 &#40;minus one since zero is a count&#41;, that means the timer period would be <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>d</mi></mrow></msub><mo>=</mo><mn>1000</mn><mo>×</mo><mn>1</mn><mi mathvariant=normal >/</mi><mo stretchy=false >(</mo><mn>20</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>3</mn></msup><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">T_{period}=1000 \times 1/(20\times10^3)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.72777em;vertical-align:-0.08333em;"></span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span><span class=mord >0</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >1</span><span class=mord >/</span><span class=mopen >(</span><span class=mord >2</span><span class=mord >0</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord >1</span><span class=mord ><span class=mord >0</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span> or <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>r</mi><mi>u</mi><mi>p</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>20</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>3</mn></msup><mi mathvariant=normal >/</mi><mn>1000</mn><mo>=</mo><mn>20</mn><mi>H</mi><mi>z</mi></mrow><annotation encoding="application/x-tex">f_{interrupt} = 20\times10^3 / 1000 = 20Hz</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.980548em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.72777em;vertical-align:-0.08333em;"></span><span class=mord >2</span><span class=mord >0</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.064108em;vertical-align:-0.25em;"></span><span class=mord >1</span><span class=mord ><span class=mord >0</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mord >/</span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span><span class=mord >0</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >2</span><span class=mord >0</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span></p> <ol start=6 > <li><p>We tell the timer to generate an interrupt when it reaches the autoreload value, by setting the <code>UIE</code> bit in the <code>DIER</code> register. </p> <li><p>Now we enable the timer counter by setting the <code>CEN</code> bit in the <code>CR1</code> register. </p> </ol> <pre><code class="cpp hljs"><span class=hljs-comment >/* Enable Timer 2 peripheral */</span>
RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM2EN;
<span class=hljs-comment >/* Default APB1 speed is 16MHz. Scale Timer 2 to 20kHz */</span>
TIM2-&gt;PSC = (<span class=hljs-type >uint32_t</span>)(<span class=hljs-number >16E6</span> / <span class=hljs-number >20E3</span>) - <span class=hljs-number >1</span>;
<span class=hljs-comment >/* Disable Timer*/</span>
TIM2-&gt;CR1 = <span class=hljs-number >0</span>;
<span class=hljs-comment >/* Reinitialize counter and update registers */</span>
TIM2-&gt;EGR = TIM_EGR_UG;
<span class=hljs-comment >/* 1000 Counts at 20kHz =&gt; 20Hz IRQ */</span>
TIM2-&gt;ARR = <span class=hljs-number >1000</span> - <span class=hljs-number >1</span>;
<span class=hljs-comment >/* Enable hardware interrupts */</span>
TIM2-&gt;DIER |= TIM_DIER_UIE;
<span class=hljs-comment >/* Start Timer */</span>
TIM2-&gt;CR1 |= TIM_CR1_CEN;</code></pre> <p>Next we have to tell the CPU to enable the <strong>response</strong> to interrupts generated by Timer 2, we can also set the priority of those interrupts. </p> <pre><code class="cpp hljs"><span class=hljs-built_in >NVIC_SetPriority</span>(TIM2_IRQn, <span class=hljs-number >2</span>);
<span class=hljs-built_in >NVIC_EnableIRQ</span>(TIM2_IRQn);</code></pre> <p>We have completed the configuration of the timer. The remaining step would be to define the function that would be called when Timer 2 issues an interrupt. </p> <p>In the startup file <a href="/me319/assets/reference_code/startup_stm32f401xe.s"><code>startup_stm32f401xe.S</code></a> you can see in line 171 a name of a function that matches Timer 2. </p> <pre><code class="cpp hljs">.word     TIM2_IRQHandler                   <span class=hljs-comment >/* TIM2                         */</span></code></pre>
<p><code>TIM2_IRQHandler</code> is the default name given to the function associated with any interrupt generated by Timer 2 &#40;from which there could be more than one, for more than one event type&#41;. This function name and other interrupt handler names are listed in what&#39;s called a <strong>vector table</strong>. This table preserves a sequenced list of addresses for all available interrupt handlers on the cpu. This table is what the CPU would use to locate the address to go to in response to an interrupt. </p>
<p>These interrupt handler functions are declared <code>weak</code> by default, which allows you to define them, and when you define them you override the weak declaration. You are probably used to having your code call the function you declare, but remember this is an interrupt handler, you only need to define the handler, and the CPU will take care of calling it when an associated interrupt event occurs. </p>
<p>In the declaration of the function, we check the <code>UIF</code> bit in the <code>SR</code> register to verify the type of event that occurred, which indicates an update event &#40;count to autoreload completed&#41;. In other words, if that bit is set then the timer has indeed raised a flag when it completed the count. </p>
<blockquote>
<p>We might not need to do this verification since we don&#39;t expect other interrupt flags to be raised by the timer. Meaning any call to TIM2_IRQHandler&#40;&#41; would be in response to a timer period complete event. </p>
</blockquote>
<p>When inside the interrupt handler, we have to clear the update flag bit in the <code>SR</code> register. This allows for the interrupt flag to be raised again, otherwise the interrupt handler will not be called on subsequent update events. </p>
<pre><code class="cpp hljs"><span class=hljs-function ><span class=hljs-type >void</span> <span class=hljs-title >TIM2_IRQHandler</span><span class=hljs-params >()</span></span>{
    <span class=hljs-comment >/* Check what type of event occurred */</span>
    <span class=hljs-keyword >if</span> (TIM2-&gt;SR &amp; TIM_SR_UIF)
    {
        <span class=hljs-comment >/* Clear the interrupt even flag. CPU will only respond to new flags thereafter */</span>
        TIM2-&gt;SR &amp;= ~(TIM_SR_UIF);
        GPIOA-&gt;ODR ^= GPIO_ODR_OD5;
    }
}</code></pre>
<blockquote>
<p>Unlike the callback functions when using the Arduino framework, which the interrupt handlers are similar to. The interrupt handler must have the exam same function name as declared in the startup file vector table. If you need to change the name, you would have to change the name in the startup file as well. The Arduino API actually uses these interrupt handlers within its stack. </p>
</blockquote>
<h3 id=example_1_complete ><a href="#example_1_complete" class=header-anchor ><em>Example 1 Complete</em></a></h3>
<p>The complete example is shown below. It should work stand-alone on PlatformIO with the <code>stm32cube</code> framework. </p>
<pre><code class="cpp hljs"><span class=hljs-comment >/* Example 1: 
 * A bare-metal example for configuring Timer to issue a periodic interrupt.
 * The timer is configured to generate an interrupt at 20Hz.
 * The LED is toggled at each IRQ call. Effectively producing a 10Hz square wave signal.
 */</span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;stm32f4xx.h&quot;</span></span>

<span class=hljs-comment >/* The name of the IRQ function should match the one in the vector table in the startup file */</span>
<span class=hljs-function ><span class=hljs-type >void</span> <span class=hljs-title >TIM2_IRQHandler</span><span class=hljs-params >()</span></span>{
    <span class=hljs-comment >/* Check what type of event occurred */</span>
    <span class=hljs-keyword >if</span> (TIM2-&gt;SR &amp; TIM_SR_UIF)
    {
        <span class=hljs-comment >/* Clear the interrupt even flag. CPU will only respond to new flags thereafter */</span>
        TIM2-&gt;SR &amp;= ~(TIM_SR_UIF);
        GPIOA-&gt;ODR ^= GPIO_ODR_OD5;
    }
}

<span class=hljs-function ><span class=hljs-type >int</span> <span class=hljs-title >main</span><span class=hljs-params >()</span></span>{
    <span class=hljs-comment >/* Enable GPIOA Clock */</span>
    RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
    <span class=hljs-comment >/* Set Port A Pin 5 as Output */</span>
    GPIOA-&gt;MODER |= GPIO_MODER_MODER5_0;

    <span class=hljs-comment >/* Enable Timer 2 peripheral */</span>
    RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM2EN;
    <span class=hljs-comment >/* Default APB1 speed is 16MHz. Scale Timer 2 to 20kHz */</span>
    TIM2-&gt;PSC = (<span class=hljs-type >uint32_t</span>)(<span class=hljs-number >16E6</span> / <span class=hljs-number >20E3</span>) - <span class=hljs-number >1</span>;
    <span class=hljs-comment >/* Disable Timer*/</span>
    TIM2-&gt;CR1 = <span class=hljs-number >0</span>;
    <span class=hljs-comment >/* Reinitialize all registers */</span>
    TIM2-&gt;EGR = TIM_EGR_UG;
    <span class=hljs-comment >/* 1000 Counts at 20kHz =&gt; 20Hz IRQ */</span>
    TIM2-&gt;ARR = <span class=hljs-number >1000</span> - <span class=hljs-number >1</span>;
    <span class=hljs-comment >/* Enable hardware interrupts */</span>
    TIM2-&gt;DIER |= TIM_DIER_UIE;
    <span class=hljs-comment >/* Start Timer */</span>
    TIM2-&gt;CR1 |= TIM_CR1_CEN;

    <span class=hljs-comment >/* These are CMSIS calls to enable interrupts */</span>
    <span class=hljs-built_in >NVIC_SetPriority</span>(TIM2_IRQn, <span class=hljs-number >2</span>);
    <span class=hljs-built_in >NVIC_EnableIRQ</span>(TIM2_IRQn);

    <span class=hljs-keyword >while</span> (<span class=hljs-number >1</span>){
        <span class=hljs-comment >/* Do nothing here */</span>
    }
}</code></pre>
<div class=page-foot >
  <div class=copyright >
    &copy; Ali AlSaibie, PhD. Last modified: June 17, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div>