<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/me319/libs/katex/katex.min.css"> <link rel=stylesheet  href="/me319/libs/highlight/github.min.css"> <link rel=stylesheet  href="/me319/css/franklin.css"> <link rel=stylesheet  href="/me319/css/poole_hyde.css"> <link rel=stylesheet  href="/me319/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 968px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/me319/assets/c.svg"> <title>Lab 6 Extra - Introduction to Kalman Filter</title> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <br> <img src="/me319/assets/KuwaitUniversityLogoTextLight.svg" style="width: 200px; height: auto; display: inline"> <h1 style="font-size:2em; opacity: 0.75;"><a href="/me319/">ME 319</a></h1> <p class=lead >Mechatronics</p> </div> <script> function hidePart(part_div) { var x = document.getElementById(part_div); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/me319/">Home</a> <a class="sidebar-nav-item " href="/me319/videos/">Lecture Videos</a> <a class="sidebar-nav-item " href="https://alsaibie.github.io/embedded_ccpp">Embedded C/C++ Mini-Course</a> <a class="sidebar-nav-item " href="/me319/lab_assignments/">Lab Assignments</a> <br> <small style="text-transform: uppercase; font-size: 0.75em">Lab Lessons</small> <div class=part  onclick="hidePart('prelabs_div')">Prelabs</div> <div id=prelabs_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabs/prelab2/"><b>Lab 2</b> - <em>PlatformIO and Arduino</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab3/"><b>Lab 3</b> - <em>Debugging and LL Programming</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab4/"><b>Lab 4</b> - <em>Timers and Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab5/"><b>Lab 5</b> - <em>Serial Communication</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab6/"><b>Lab 6</b> - <em>Offline Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab7/"><b>Lab 7</b> - <em>Online Digital Filtering</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab8/"><b>Lab 8</b> - <em>Motor Dynamics and Control</em></a> <a class="sidebar-nav-item " href="/me319/prelabs/prelab9/"><b>Lab 9</b> - <em>Realtime Motor Control</em></a> </div> <div class=part  onclick="hidePart('addlessons_div')">Additional Lessons</div> <div id=addlessons_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/prelabsextra/lab4extra/"> <b>L4E</b> - <em>Low Level Timers Configuration</em></a> <a class="sidebar-nav-item active" href="/me319/prelabsextra/kalmanfilter/"> <b>L6E</b> - <em>Kalman Filter</em></a> </div> <br> <small style="text-transform: uppercase; font-size: 0.75em">Class Lectures</small> <div class=part  onclick="hidePart('part1_div')">I The Brain</div> <div id=part1_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_i/lecture0/"><b>L0</b> - <em>Introduction</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture1/"><b>L1</b> - <em>Microcontroller Architecture</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture2/"><b>L2</b> - <em>Digital Arithmetic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture3/"><b>L3</b> - <em>Digital Logic</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture4/"><b>L4</b> - <em>Microcontroller Peripherals</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture5/"><b>L5</b> - <em>GPIO</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture6/"><b>L6</b> - <em>Timers</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture7/"><b>L7</b> - <em>Interrupts</em></a> <a class="sidebar-nav-item " href="/me319/part_i/lecture8/"><b>L8</b> - <em>Communication</em></a> </div> <div class=part  onclick="hidePart('part2_div')">II The Cells</div> <div id=part2_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_ii/lecture1/"><b>L1</b> - <em>Passive Circuits</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture2/"><b>L2</b> - <em>Switching Semiconductors</em></a> <a class="sidebar-nav-item " href="/me319/part_ii/lecture3/"><b>L3</b> - <em>Operational Amplifiers</em></a> </div> <div class=part  onclick="hidePart('part3_div')">III The Senses</div> <div id=part3_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iii/lecture1/"><b>L1</b> - <em>Signal Conditioning and Filtering</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture2/"><b>L2</b> - <em>Sensor Charactersitics</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture3/"><b>L3</b> - <em>Survey of Sensors</em></a> <a class="sidebar-nav-item " href="/me319/part_iii/lecture4/"><b>L4</b> - <em>Motion Sensors</em></a> </div> <div class=part  onclick="hidePart('part4_div')">IV The Muscles</div> <div id=part4_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_iv/lecture1/"><b>L1</b> - <em>DC Motors</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture2/"><b>L2</b> - <em>Practical Feedback Control</em></a> <a class="sidebar-nav-item " href="/me319/part_iv/lecture4/"><b>L3</b> - <em>Stepper Motors</em></a> </div> <div class=part  onclick="hidePart('part5_div')">V The Body</div> <div id=part5_div  style="display:none;"> <a class="sidebar-nav-item " href="/me319/part_v/lecture1/"><b>L1</b> - <em>System Integration</em></a> </div> </nav> <p>&copy; Ali AlSaibie, PhD.</p> </div> </div> <div class="content container"> <div class=franklin-content ><h1 id=kalman_filter ><a href="#kalman_filter" class=header-anchor >Kalman Filter</a></h1> <h2 id=pendulum_dynamics ><a href="#pendulum_dynamics" class=header-anchor >Pendulum Dynamics</a></h2> <p>We will explore the use of a Kalman Filter to estimate the state of a free pendulum starting from an initial state with damped oscillation. We will first explore the use of a linear Kalman Filter based on a linearized model of the pendulum dynamics. Then, we will look at using an Extended Kalman Filter to estimate the states.</p> <p>The following are the dynamics of the system:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mover accent=true ><mi>x</mi><mo>˙</mo></mover><mo>=</mo><mrow><mo fence=true >[</mo><mtable rowspacing=0.15999999999999992em  columnalign=center  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mover accent=true ><mi>θ</mi><mo>˙</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mover accent=true ><mi>θ</mi><mo>¨</mo></mover></mstyle></mtd></mtr></mtable><mo fence=true >]</mo></mrow><mo>=</mo><mrow><mo fence=true >[</mo><mtable rowspacing=0.15999999999999992em  columnalign=center  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mover accent=true ><mi>θ</mi><mo>˙</mo></mover></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mfrac><mrow><mo>−</mo><mi>b</mi></mrow><mtext>mL</mtext></mfrac><mover accent=true ><mi>θ</mi><mo>˙</mo></mover><mo>−</mo><mfrac><mi>g</mi><mi>L</mi></mfrac><mi>sin</mi><mo>⁡</mo><mrow><mo fence=true >(</mo><mi>θ</mi><mo fence=true >)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><mo fence=true >]</mo></mrow></mrow><annotation encoding="application/x-tex">\dot{x} =\left\lbrack \begin{array}{c} \dot{\theta} \\ \ddot{\theta} \end{array}\right\rbrack =\left\lbrack \begin{array}{c} \dot{\theta} \\ \frac{-b}{\mathit{\text{mL}}}\dot{\theta} -\frac{g}{L}\sin \left(\theta \right) \end{array}\right\rbrack</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.66786em;vertical-align:0em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.66786em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.11111000000000001em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.5826000000000002em;vertical-align:-1.0413000000000003em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.5413em;"><span style="top:-3.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span></span></span><span style="top:-2.3186999999999998em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.16666em;"><span class=mord >¨</span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.0413000000000003em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.5826000000000002em;vertical-align:-1.0413000000000003em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.5413em;"><span style="top:-3.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span></span></span><span style="top:-2.3186999999999998em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">mL</span></span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop >sin</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=minner ><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.0413000000000003em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span> <p>Let&#39;s integrate this over a fixed time interval with an initial state. </p> <p><pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots
<span class=hljs-keyword >using</span> DifferentialEquations

<span class=hljs-comment ># Pendulum Parameters</span>
m = <span class=hljs-number >0.5</span>;  <span class=hljs-comment ># Mass of the pendulum</span>
b = <span class=hljs-number >0.25</span>; <span class=hljs-comment ># Damping Coefficient</span>
L = <span class=hljs-number >2.8</span>;  <span class=hljs-comment ># Length of the Pendulum </span>
g = <span class=hljs-number >9.81</span>; <span class=hljs-comment ># Gravitational Constant, the average nominal value on Earth,</span>
          <span class=hljs-comment ># not necessarily where you are standing right now. In fact, the gravitational constant varies 0.7% </span>
          <span class=hljs-comment ># across different earth locations, but let&#x27;s get back to our lesson. </span>

<span class=hljs-keyword >function</span> pendulum!(dx, x, p, t)
    dx[<span class=hljs-number >1</span>] = x[<span class=hljs-number >2</span>]; 
    dx[<span class=hljs-number >2</span>] = -b/(m*L)*x[<span class=hljs-number >2</span>] - g/L * sin(x[<span class=hljs-number >1</span>])
<span class=hljs-keyword >end</span>

θₒ = <span class=hljs-literal >π</span>/<span class=hljs-number >4</span>;
ωₒ = <span class=hljs-number >0</span>;
xₒ = [θₒ, ωₒ];

Δt = <span class=hljs-number >0.1</span>; 

tspan = (<span class=hljs-number >0.0</span>, <span class=hljs-number >10.0</span>)

prob = ODEProblem(pendulum!,xₒ,tspan)
sol = solve(prob, saveat = Δt)
t = sol.t

<span class=hljs-keyword >function</span> draw_pendulum(θ_list)
    L = <span class=hljs-number >1</span>;
    <span class=hljs-keyword >local</span> p = plot()
    <span class=hljs-keyword >for</span> θ <span class=hljs-keyword >in</span> θ_list
        plot!(p, [<span class=hljs-number >0</span>,L*sin(θ)], [<span class=hljs-number >0</span>,-L*cos(θ)],size=(<span class=hljs-number >300</span>,<span class=hljs-number >300</span>),xlim=(-<span class=hljs-number >1.2</span>*L,<span class=hljs-number >1.2</span>*L),ylim=(-L*<span class=hljs-number >1.2</span>,<span class=hljs-number >1</span>),ms=<span class=hljs-number >2</span>, markershape = :hexagon,label =<span class=hljs-string >&quot;&quot;</span>, axis = []);
        plot!(p, [L*sin.(θ)], [-L*cos.(θ)], ms=<span class=hljs-number >8</span>, markershape = :circle, label =<span class=hljs-string >&quot;&quot;</span>, aspect_ratio = :equal, showaxis = <span class=hljs-literal >false</span>);
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> p
<span class=hljs-keyword >end</span>

anim = <span class=hljs-meta >@animate</span> <span class=hljs-keyword >for</span> i ∈ <span class=hljs-number >1</span>:length(t)
    panim = draw_pendulum([sol[<span class=hljs-number >1</span>,i]])
    <span class=hljs-keyword >local</span> p = plot(sol[<span class=hljs-number >1</span>:i], lw=<span class=hljs-number >2</span>, label=[<span class=hljs-string >&quot;θ [rad]&quot;</span> <span class=hljs-string >&quot;ω [rad/s]&quot;</span>], layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))
    plot(panim, p, layout=grid(<span class=hljs-number >1</span>, <span class=hljs-number >2</span>, widths=[<span class=hljs-number >0.35</span> , <span class=hljs-number >.65</span>]), size=size=(<span class=hljs-number >800</span>, <span class=hljs-number >400</span>))
<span class=hljs-keyword >end</span></code></pre> <img src="/me319/prelabsextra/kfassets/snippet1.gif" alt=""></p> <p>Now let us assume we want to measure the angular position and angular velocity, but we don&#39;t have a sophisticated measurement device and so the measurements are noisy. Let&#39;s assume the measurement noise is white, Gaussian, not correlated and with zero-mean. Let&#39;s add that affect onto the process. Assume the measurements are taken at a sample time of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Δ</mi><mi>t</mi><mo>=</mo><mn>0.1</mn><mi>s</mi></mrow><annotation encoding="application/x-tex">\Delta t = 0.1 s</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Δ</span><span class="mord mathnormal">t</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span><span class=mord >.</span><span class=mord >1</span><span class="mord mathnormal">s</span></span></span></span></p> <p><pre><code class="julia hljs"><span class=hljs-keyword >using</span> LinearAlgebra
σ_θ = <span class=hljs-number >.25</span>;
σ_ω = <span class=hljs-number >.5</span>;
rms(x) = norm(x)/sqrt(length(x))
noise = [σ_θ*randn(length(t))&#x27;; σ_ω*randn(length(t))&#x27;] 
sol_noisy = zeros(size(sol))
sol_noisy = sol + noise
ϵ = (sol-sol_noisy)
<span class=hljs-meta >@show</span> ϵ_rms = [rms(ϵ[<span class=hljs-number >1</span>,:]),  rms(ϵ[<span class=hljs-number >2</span>,:])]


anim = <span class=hljs-meta >@animate</span> <span class=hljs-keyword >for</span> i ∈ <span class=hljs-number >1</span>:length(t)
    <span class=hljs-keyword >local</span> p = plot(sol[<span class=hljs-number >1</span>:i], lw=<span class=hljs-number >2</span>, label=[<span class=hljs-string >&quot;θ [rad]&quot;</span> <span class=hljs-string >&quot;ω [rad/s]&quot;</span>], layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))
    scatter!(p, t[<span class=hljs-number >1</span>:i], sol_noisy[:,<span class=hljs-number >1</span>:i]&#x27;, label=[<span class=hljs-string >&quot;θ measured [rad]&quot;</span> <span class=hljs-string >&quot;ω measured [rad/s]&quot;</span>], ms=<span class=hljs-number >1</span>, layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))
<span class=hljs-keyword >end</span></code></pre> <pre><code class="plaintext hljs">ϵ_rms = [rms(ϵ[1, :]), rms(ϵ[2, :])] = [0.24841861668835655, 0.5037134425875269]
</code></pre> <img src="/me319/prelabsextra/kfassets/snippet2.gif" alt=""></p> <p>Now this may be an exaggerated noise level, we can change the standard deviation of the measurement noise to make it better or worst, but let&#39;s keep it and see how well a Kalman Filter can perform.</p> <h2 id=linear_kalman_filter ><a href="#linear_kalman_filter" class=header-anchor >Linear Kalman Filter</a></h2> <p>We clearly don&#39;t have a decent measurement system, let&#39;s try to apply a Kalman Filter to better estimate our states. Here is a summary of the Kalman Filter for a Continuous-Discrete Time-Invariant Linear System.</p> <p>The continuous part is the model or process &#40;the pendulum is a continuous system&#41; and the discrete part is the measurement &#40;we take readings at discrete intervals&#41;.</p> <p>Given the dynamic system:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.15999999999999992em  columnalign="right center left" columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mover accent=true ><mi>x</mi><mo>˙</mo></mover><mo>=</mo><mi>A</mi><mi>x</mi><mo>+</mo><mi>B</mi><mi>u</mi><mo>+</mo><mi>G</mi><mi>w</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><msub><mi>y</mi><mi>k</mi></msub><mo>=</mo><msub><mi>H</mi><mi>k</mi></msub><msub><mi>x</mi><mi>k</mi></msub><mo>+</mo><msub><mi>v</mi><mi>k</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mi>w</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo><mo>∼</mo><mi>N</mi><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><mi>Q</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><msub><mi>v</mi><mi>k</mi></msub><mo>∼</mo><mrow><mi>N</mi><mo stretchy=false >(</mo><mn>0</mn><mo separator=true >,</mo><mi>R</mi><mo stretchy=false >)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{rcl} \dot{x} = A x + B u + G w\\\\ y_k =H_k x_k + v_k \\\\ w(t) \sim N(0, Q)\\\\ v_k \sim{N(0, R)}\\ \end{array}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:8.400000000000002em;vertical-align:-3.95em;"></span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:4.450000000000001em;"><span style="top:-6.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.66786em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.11111000000000001em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">u</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span><span style="top:-5.410000000000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ></span></span><span style="top:-4.210000000000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0100000000000002em;"><span class=pstrut  style="height:3em;"></span><span class=mord ></span></span><span style="top:-1.8100000000000003em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">Q</span><span class=mclose >)</span></span></span><span style="top:-0.6100000000000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ></span></span><span style="top:0.5900000000000001em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∼</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=mopen >(</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class=mclose >)</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.95em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span></span></span></span></span> <p>Initialized as follows:</p> <p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo stretchy=false >(</mo><mn>0</mn><mo stretchy=false >)</mo><mo>=</mo><mi>E</mi><mo stretchy=false >(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy=false >)</mo><mo>=</mo><msub><mover accent=true ><mi>x</mi><mo>ˉ</mo></mover><mn>0</mn></msub><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">\hat{x}(0)=E(x_0)=\bar{x}_0\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.71778em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.56778em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >ˉ</span></span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span></span></span> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy=false >(</mo><mn>0</mn><mo stretchy=false >)</mo><mo>=</mo><mi>E</mi><mo stretchy=false >[</mo><mo stretchy=false >(</mo><msub><mi>x</mi><mn>0</mn></msub><mo>−</mo><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo stretchy=false >(</mo><mn>0</mn><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mo stretchy=false >(</mo><msub><mi>x</mi><mn>0</mn></msub><mo>−</mo><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo stretchy=false >(</mo><mn>0</mn><mo stretchy=false >)</mo><msup><mo stretchy=false >)</mo><mi>T</mi></msup><mo stretchy=false >]</mo><mo>=</mo><msub><mi>P</mi><mn>0</mn></msub><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">P(0)= E[(x_0 -\hat{x}(0))(x_0 -\hat{x}(0))^T]=P_0\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=mopen >(</span><span class=mord >0</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class=mopen >[</span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mclose >)</span><span class=mclose >)</span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord >0</span><span class=mclose >)</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span></span></span></p> <p>The time-update &#40;process-update&#41; is in the continuous domain</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mover accent=true ><mi>P</mi><mo>˙</mo></mover><mo>=</mo><mi>A</mi><mi>P</mi><mo>+</mo><mi>P</mi><msup><mi>A</mi><mi>T</mi></msup><mo>+</mo><mi>G</mi><mi>Q</mi><msup><mi>G</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\dot{P}=AP + PA^T + GQG^T</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.9201900000000001em;vertical-align:0em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9201900000000001em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.25233em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.9746609999999999em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.0857709999999998em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">G</span><span class="mord mathnormal">Q</span><span class=mord ><span class="mord mathnormal">G</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mover accent=true ><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>˙</mo></mover><mo>=</mo><mi>A</mi><msup><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>+</mo></msup><mo>+</mo><mi>B</mi><mi>u</mi></mrow><annotation encoding="application/x-tex">\dot{\hat{x}} = A \hat{x}^+ + B u</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.9313em;vertical-align:0em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.13889em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.904661em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">A</span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.821331em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">u</span></span></span></span></span> <p>Numerically integrate with <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta t</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Δ</span><span class="mord mathnormal">t</span></span></span></span> as the time step</p> <p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>−</mo></msup><mo>=</mo><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>+</mo><mover accent=true ><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>˙</mo></mover><mi mathvariant=normal >Δ</mi><mi>t</mi><mspace linebreak=newline ></mspace><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">\hat{x}^-=\hat{x} + \dot{\hat{x}} \Delta t\\\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.771331em;vertical-align:0em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.9313em;vertical-align:0em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.13889em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mord >Δ</span><span class="mord mathnormal">t</span></span><span class="mspace newline"></span><span class="mspace newline"></span></span></span> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>P</mi><mo>−</mo></msup><mo>=</mo><mi>P</mi><mo>+</mo><mover accent=true ><mi>P</mi><mo>˙</mo></mover><mi mathvariant=normal >Δ</mi><mi>t</mi><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">P^- = P + \dot{P}\Delta t\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.771331em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.9201900000000001em;vertical-align:0em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9201900000000001em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.25233em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mord >Δ</span><span class="mord mathnormal">t</span></span><span class="mspace newline"></span></span></span></p> <p>And then a measurement-update in discrete form</p> <p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msup><mi>P</mi><mo>−</mo></msup><msup><mi>H</mi><mi>T</mi></msup><msup><mrow><mo stretchy=false >(</mo><mi>H</mi><msup><mi>P</mi><mo>−</mo></msup><msup><mi>H</mi><mi>T</mi></msup><mo>+</mo><mi>R</mi><mo stretchy=false >)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mspace linebreak=newline ></mspace><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">K =P^- H^T {(H P^- H^T +R )}^{-1}\\\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.2953389999999998em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class=mclose >)</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:1.0453389999999998em;"><span style="top:-3.294231em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="mspace newline"></span></span></span> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>=</mo><msup><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>−</mo></msup><mo>+</mo><mi>K</mi><mo stretchy=false >(</mo><mi>y</mi><mo>−</mo><mi>H</mi><msup><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>−</mo></msup><mo stretchy=false >)</mo><mspace linebreak=newline ></mspace><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">{\hat{x} } ={\hat{x} }^- +K (y -H {\hat{x} }^- )\\\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.939001em;vertical-align:-0.08333em;"></span><span class=mord ><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.855671em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.105671em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mord ><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.855671em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mclose >)</span></span><span class="mspace newline"></span><span class="mspace newline"></span></span></span> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>=</mo><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><mi>K</mi><mi>H</mi><mo stretchy=false >)</mo><msup><mi>P</mi><mo>−</mo></msup><msup><mrow><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><mi>K</mi><mi>H</mi><mo stretchy=false >)</mo></mrow><mi>T</mi></msup><mo>+</mo><mi>K</mi><mi>R</mi><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><mi>K</mi><mi>H</mi><mo stretchy=false >)</mo><msup><mi>P</mi><mo>−</mo></msup><mspace linebreak=newline ></mspace></mrow><annotation encoding="application/x-tex">P=(I-K H )P^- {(I-K H )}^T +K R K^T=(I-K H )P^-\\</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.231231em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mclose >)</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mclose >)</span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.981231em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.021331em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mclose >)</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span></span><span class="mspace newline"></span></span></span></p> <p>Here <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>+</mo></msup></mrow><annotation encoding="application/x-tex">\hat{x}^+</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.771331em;vertical-align:0em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span></span></span></span>, the aposteriori estimate, is expressed as <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent=true ><mi>x</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{x}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span></span></span></span></p> <p>We have to linearize our pendulum system before we use the Kalman Filter above, let&#39;s assume a small angle approximation, this would result in the system:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.15999999999999992em  columnalign="right center left" columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mover accent=true ><mi>x</mi><mo>˙</mo></mover><mo>=</mo><mtext>A</mtext><mi>x</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo><mo>+</mo><mi>w</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo><mo>=</mo><mo stretchy=false >[</mo><mtable rowspacing=0.15999999999999992em  columnalign=center  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mo>−</mo><mfrac><mi>g</mi><mi>L</mi></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mo>−</mo><mfrac><mi>b</mi><mrow><mi>m</mi><mi>L</mi></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><mo stretchy=false >]</mo><mo stretchy=false >[</mo><mtable rowspacing=0.15999999999999992em  columnalign=center  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mi>θ</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mover accent=true ><mi>θ</mi><mo>˙</mo></mover></mstyle></mtd></mtr></mtable><mo stretchy=false >]</mo><mo>+</mo><mi>w</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><msub><mi>y</mi><mi>k</mi></msub><mo>=</mo><mi>H</mi><msub><mi>x</mi><mi>k</mi></msub><mo>+</mo><msub><mi>v</mi><mi>k</mi></msub><mo>=</mo><mo stretchy=false >[</mo><mtable rowspacing=0.15999999999999992em  columnalign=center  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>1</mn></mstyle></mtd></mtr></mtable><mo stretchy=false >]</mo><mo stretchy=false >[</mo><mtable rowspacing=0.15999999999999992em  columnalign=center  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mi>θ</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mover accent=true ><mi>θ</mi><mo>˙</mo></mover></mstyle></mtd></mtr></mtable><mo stretchy=false >]</mo><mo>+</mo><msub><mi>v</mi><mi>k</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{rcl} \dot{x} =\text{A}x(t)+w(t)=[ \begin{array}{c} 0 &amp; 1\\ -\frac{g}{L} &amp; -\frac{b}{mL} \end{array}] [ \begin{array}{c} \theta \\ \dot{\theta} \end{array}] + w(t)\\\\ y_k =Hx_k+v_k=[ \begin{array}{c} 1 &amp; 0\\ 0 &amp; 1 \end{array}] [ \begin{array}{c} \theta \\ \dot{\theta} \end{array}] + v_k \end{array}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:6.182600000000001em;vertical-align:-2.841300000000001em;"></span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.3413000000000004em;"><span style="top:-5.3413em;"><span class=pstrut  style="height:3.4956500000000004em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.66786em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.11111000000000001em;"><span class=mord >˙</span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord text"><span class=mord >A</span></span><span class="mord mathnormal">x</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mopen >[</span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.470054em;"><span style="top:-3.630054em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-2.3899459999999997em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >−</span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9700540000000004em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.470054em;"><span style="top:-3.630054em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span><span style="top:-2.3899459999999997em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >−</span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">L</span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9700540000000004em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span><span class=mclose >]</span><span class=mopen >[</span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.4956500000000001em;"><span style="top:-3.65565em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-2.3643499999999995em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9956500000000006em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span></span></span><span style="top:-3.5056499999999997em;"><span class=pstrut  style="height:3.4956500000000004em;"></span><span class=mord ></span></span><span style="top:-1.6500000000000001em;"><span class=pstrut  style="height:3.4956500000000004em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mopen >[</span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.45em;"><span style="top:-3.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span><span style="top:-2.4099999999999997em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.45em;"><span style="top:-3.61em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-2.4099999999999997em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9500000000000004em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span><span class=mclose >]</span><span class=mopen >[</span><span class=mord ><span class=mtable ><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.4956500000000001em;"><span style="top:-3.65565em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-2.3643499999999995em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9313em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.055550000000000016em;"><span class=mord >˙</span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.9956500000000006em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:2.841300000000001em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span></span></span></span></span></span></span> <p><pre><code class="julia hljs"><span class=hljs-meta >@show</span> A = [<span class=hljs-number >0</span> <span class=hljs-number >1</span>; -g/L -b/(m*L)]
B = [<span class=hljs-number >0</span>; <span class=hljs-number >0</span>]; H = [<span class=hljs-number >1</span> <span class=hljs-number >0</span>; <span class=hljs-number >0</span> <span class=hljs-number >1</span>];

n = <span class=hljs-number >2</span>; <span class=hljs-comment ># Number of States</span>
m = <span class=hljs-number >2</span>; <span class=hljs-comment ># Number of Outputs</span>
points = length(t); <span class=hljs-comment ># Number of measurements </span>

<span class=hljs-meta >@show</span> Q = [<span class=hljs-number >0.1</span>^<span class=hljs-number >2</span> <span class=hljs-number >0</span>; <span class=hljs-number >0</span> <span class=hljs-number >0.25</span>^<span class=hljs-number >2</span>];
<span class=hljs-meta >@show</span> R = [σ_θ^<span class=hljs-number >2</span> <span class=hljs-number >0</span>; <span class=hljs-number >0</span> σ_ω^<span class=hljs-number >2</span>]

P = zeros(n, n, points);
K = zeros(n, m, points);

P[:,:,<span class=hljs-number >1</span>] = diagm([<span class=hljs-number >0.01</span>^<span class=hljs-number >2</span>, <span class=hljs-number >0.01</span>^<span class=hljs-number >2</span>]);

x̂ = zeros(n, points);
x̂[:,<span class=hljs-number >1</span>] = xₒ;
z = sol_noisy;

<span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >2</span>:length(t)
    <span class=hljs-comment ># Time update a.k.a Prediction a.k.a State Propagation</span>
    ẋ = A * x̂[:,k-<span class=hljs-number >1</span>];
    Ṗ = A * P[:,:,k-<span class=hljs-number >1</span>] + P[:,:,k-<span class=hljs-number >1</span>] * A&#x27; + Q; 

    <span class=hljs-comment ># Integrate to propagate apriori state and apriori covariance</span>
    x̂⁻ = x̂[:,k-<span class=hljs-number >1</span>] +  ẋ * Δt
    P⁻ = P[:,:,k-<span class=hljs-number >1</span>] + Ṗ * Δt

    <span class=hljs-comment ># Kalman Gain. Larger gains puts a heavier weight on the measurement and vice versa.</span>
    K[:,:,k] = P⁻*H&#x27; * inv( H*P⁻*H&#x27; + R);
    
    <span class=hljs-comment ># Measurements Update </span>
    x̂[:,k] = x̂⁻ + K[:,:,k] *(z[:,k] - H * x̂⁻);  <span class=hljs-comment ># aposteriori state estimate update</span>
    P[:,:,k] = (I - K[:,:,k] * H) * P⁻;         <span class=hljs-comment ># aposteriori error covariance update</span>
<span class=hljs-keyword >end</span>

kf_e = (sol - x̂);
kf_e_rms = [rms(kf_e[<span class=hljs-number >1</span>,:]),  rms(kf_e[<span class=hljs-number >2</span>,:])]
<span class=hljs-meta >@show</span> kf_e_rms

anim = <span class=hljs-meta >@animate</span> <span class=hljs-keyword >for</span> i ∈ <span class=hljs-number >1</span>:length(t)
    panim = draw_pendulum([sol[<span class=hljs-number >1</span>,i] x̂[<span class=hljs-number >1</span>,i]])
    <span class=hljs-keyword >local</span> p = plot(sol[<span class=hljs-number >1</span>:i], lw=<span class=hljs-number >2</span>, label=[<span class=hljs-string >&quot;θ [rad]&quot;</span> <span class=hljs-string >&quot;ω [rad/s]&quot;</span>], layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))
    scatter!(p, t[<span class=hljs-number >1</span>:i], sol_noisy[:,<span class=hljs-number >1</span>:i]&#x27;, label=[<span class=hljs-string >&quot;θ measured [rad]&quot;</span> <span class=hljs-string >&quot;ω measured [rad/s]&quot;</span>], ms=<span class=hljs-number >1</span>, layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))
    plot!(p, t[<span class=hljs-number >1</span>:i], x̂[:,<span class=hljs-number >1</span>:i]&#x27;, label=[<span class=hljs-string >&quot;θ estimated [rad]&quot;</span> <span class=hljs-string >&quot;ω estimated [rad/s]&quot;</span>], lw=<span class=hljs-number >2</span>, layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))
    plot(panim, p, layout=grid(<span class=hljs-number >1</span>, <span class=hljs-number >2</span>, widths=[<span class=hljs-number >0.35</span> , <span class=hljs-number >.65</span>]), size=size=(<span class=hljs-number >800</span>, <span class=hljs-number >400</span>))
<span class=hljs-keyword >end</span></code></pre> <pre><code class="plaintext hljs">A = [0 1; -g / L -b / (m * L)] = [0.0 1.0; -3.503571428571429 -0.044642857142857144]
Q = [0.1 ^ 2 0; 0 0.25 ^ 2] = [0.010000000000000002 0.0; 0.0 0.0625]
R = [σ_θ ^ 2 0; 0 σ_ω ^ 2] = [0.0625 0.0; 0.0 0.25]
kf_e_rms = [0.08465364260080768, 0.16970747738721473]
</code></pre> <img src="/me319/prelabsextra/kfassets/snippet3.gif" alt=""></p> <p>What&#39;s happening above is that state is propagated by using our knowledge of the pendulum physics &#40;the model&#41;, which results in the apriori estimate <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover accent=true ><mi>x</mi><mo>^</mo></mover><mo>−</mo></msup></mrow><annotation encoding="application/x-tex">\hat{x}^-</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.771331em;vertical-align:0em;"></span><span class=mord ><span class="mord accent"><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.69444em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">x</span></span></span><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.22222em;"><span class=mord >^</span></span></span></span></span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span></span></span></span>. </p> <p>The covariance matrix <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> is also propagated through time using the model physics &#40;the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> matrix&#41;, the covariance matrix holds the stochastic information of each state and the statistical relationship of the states. </p> <p>Notice that in the situation above, it is independent of the state. In fact, it can be precalculated off-line, and it can converge after a time-period.</p> <pre><code class="julia hljs"><span class=hljs-comment ># Time update a.k.a Prediction a.k.a State Propagation</span>
ẋ = A * x̂[:,k-<span class=hljs-number >1</span>];
Ṗ = A * P[:,:,k-<span class=hljs-number >1</span>] + P[:,:,k-<span class=hljs-number >1</span>] * A&#x27; + Q; 

x⁻ = x̂[:,k-<span class=hljs-number >1</span>] +  ẋ * Δt
P⁻ = P[:,:,k-<span class=hljs-number >1</span>] + Ṗ * Δt</code></pre> <p>The time-update step can be done multiple times before the measurement update occurs. You can do 5 process updates for every measurement update for example. Measurement updates can be synchronous or asynchronous as well. </p> <p>When a new measurement is ready, we perform the <strong>measurement update</strong> step. We compute the Kalman gain which is a function of the covariance matrix, the sensor &#40;output matrix <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span>&#41; and the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> matrix which holds the stochastic specification of the measurement model.</p> <pre><code class="julia hljs"><span class=hljs-comment ># Kalman Gain. Larger gains puts a heavier weight on the measurement and vice versa.</span>
K[:,:,k] = P⁻*H&#x27; * inv( H*P⁻*H&#x27; + R);</code></pre> <blockquote> <p>Think of the Kalman Gain as a weighting factor for the measurement versus the process &#40;the estimate from the physics: the integration of the model&#41;. If, stochastically, we trust the process more than the measurement, the gain would be low. If we trust the measurement more, then the gain would be high. </p> </blockquote> <p>Then we use the gain to compute the estimate of the state, called the <strong>aposteriori</strong> based on the steps above it. As well as update the aposteriori of the covariance matrix</p> <pre><code class="julia hljs"><span class=hljs-comment ># Measurements Update </span>
x̂[:,k] = x̂⁻ + K[:,:,k] *(z[:,k] - H * x̂⁻);  <span class=hljs-comment ># aposteriori state estimate update</span>
P[:,:,k] = (I - K[:,:,k] * H) * P⁻;         <span class=hljs-comment ># aposteriori error covariance update</span></code></pre> <div class=page-foot > <div class=copyright > &copy; Ali AlSaibie, PhD. Last modified: June 19, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div>